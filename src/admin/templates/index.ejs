<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
        <link rel="stylesheet" href="/admin/style.css">
</head>
<body>
    <div class="container">

        <!-- å‹•çš„çµ±è¨ˆã‚«ãƒ¼ãƒ‰
        <div class="stats-grid">
            <% if (models && models.length > 0) { %>
                <% models.forEach(function(model) { %>
                    <% const modelStats = statistics[model.name]; %>
                    <div class="stat-card" style="border-left-color: <%= model.color || '#667eea' %>">
                        <h3 style="color: <%= model.color || '#667eea' %>">
                            <% if (model.icon) { %><%= model.icon %> <% } %>
                            <%= model.displayName %>çµ±è¨ˆ
                        </h3>
                        <% if (modelStats) { %>
                            <div class="stat-number"><%= modelStats.total || 0 %></div>
                            <div class="stat-label">ç·<%= model.displayName %>æ•°</div>
                            <% if (model.hasStatistics && modelStats.totalUsers) { %>
                                <div style="margin-top: 1rem;">
                                    <div>æ–°è¦ç™»éŒ²ï¼ˆ30æ—¥é–“ï¼‰: <strong><%= modelStats.recentRegistrations || 0 %></strong></div>
                                    <div>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong><%= modelStats.activeUsers || 0 %></strong></div>
                                </div>
                            <% } %>
                        <% } else { %>
                            <div class="error-message"><%= model.displayName %>çµ±è¨ˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
                        <% } %>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="stat-card">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãªã—</h3>
                    <div class="error-message">ç™»éŒ²ã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            <% } %>
            
            <!-- ç·åˆçµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
            <!-- <div class="stat-card" style="border-left-color: #28a745">
                <h3 style="color: #28a745">ğŸ“Š ç·åˆçµ±è¨ˆ</h3>
                <div class="stat-number"><%= totalModels || 0 %></div>
                <div class="stat-label">ç™»éŒ²ãƒ¢ãƒ‡ãƒ«æ•°</div>
                <div style="margin-top: 1rem;">
                    <div>ãƒ‡ãƒ¼ã‚¿æ›´æ–°: <strong><%= new Date(timestamp).toLocaleTimeString('ja-JP') %></strong></div>
                </div>
            </div>
        </div> -->

        <!-- Django Adminé¢¨ ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ -->
        <div class="admin-models-grid">
            <% if (models && models.length > 0) { %>
                <% models.forEach(function(model) { %>
                    <% const modelStats = statistics[model.name]; %>
                    <div class="admin-model-card" onclick="loadModelData('<%= model.name %>', '<%= model.displayName %>')">
                        <div class="admin-model-header" style="background-color: <%= model.color || '#667eea' %>">
                            <div class="admin-model-icon">
                                <%= model.icon || 'ğŸ“' %>
                            </div>
                            <div class="admin-model-info">
                                <h3><%= model.displayName %></h3>
                                <span class="admin-model-count">
                                    <%= (modelStats && modelStats.total) || 0 %> ä»¶
                                </span>
                            </div>
                        </div>
                        <div class="admin-model-actions">
                            <div class="admin-action-btn" onclick="event.stopPropagation(); loadModelData('<%= model.name %>', '<%= model.displayName %>')">
                                ğŸ“‹ ä¸€è¦§è¡¨ç¤º
                            </div>
                            <% if (model.hasStatistics) { %>
                                <div class="admin-action-btn" onclick="event.stopPropagation(); loadModelStats('<%= model.name %>', '<%= model.displayName %>')">
                                    ğŸ“Š çµ±è¨ˆæƒ…å ±
                                </div>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="admin-model-card">
                    <div class="admin-model-header" style="background-color: #dc3545">
                        <div class="admin-model-icon">âš ï¸</div>
                        <div class="admin-model-info">
                            <h3>ãƒ¢ãƒ‡ãƒ«ãªã—</h3>
                            <span class="admin-model-count">0 ä»¶</span>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="admin-two-column">
            <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå·¦å´ï¼‰ -->
            <div class="admin-data-section">
                <div class="admin-toolbar">
                    <div class="admin-toolbar-title">
                        <h2>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                        <span class="admin-toolbar-info">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºãƒ»æ“ä½œã—ã¦ãã ã•ã„</span>
                    </div>
                    <div class="admin-toolbar-actions">
                        <button class="admin-toolbar-btn" onclick="loadAllStatistics()">
                            ğŸ“Š å…¨çµ±è¨ˆ
                        </button>
                        <button class="admin-toolbar-btn" onclick="loadModelInfo()">
                            ğŸ” ãƒ¢ãƒ‡ãƒ«æƒ…å ±
                        </button>
                        <button class="admin-toolbar-btn" onclick="refreshCurrentView()">
                            ğŸ”„ æ›´æ–°
                        </button>
                    </div>
                </div>
                
                <div class="admin-data-content" id="data-table-content">
                    <div class="admin-welcome">
                        <div class="admin-welcome-icon">ğŸ </div>
                        <h3>ç®¡ç†ãƒ‘ãƒãƒ«ã¸ã‚ˆã†ã“ã</h3>
                        <p>ä¸Šã®ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„</p>
                        <% if (models && models.length > 0) { %>
                            <div class="admin-welcome-models">
                                <strong>åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«:</strong>
                                <div class="admin-welcome-tags">
                                    <% models.forEach(function(model) { %>
                                        <span class="admin-welcome-tag" style="background-color: <%= model.color || '#667eea' %>">
                                            <% if (model.icon) { %><%= model.icon %> <% } %><%= model.displayName %>
                                        </span>
                                    <% }); %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰ -->
            <div class="admin-form-section">
                <div class="admin-form-header">
                    <h2>â• æ–°è¦ä½œæˆ</h2>
                    <span class="admin-form-info">ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¦ãã ã•ã„</span>
                </div>
                
                <div class="admin-form-content" id="create-form-content">
                    <div class="admin-form-welcome">
                        <div class="admin-form-welcome-icon">âœ¨</div>
                        <h3>æ–°è¦ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h3>
                        <p>å·¦å´ã®ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€<br>ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                        <% if (models && models.length > 0) { %>
                            <div class="admin-form-models">
                                <strong>ä½œæˆå¯èƒ½ãªãƒ¢ãƒ‡ãƒ«:</strong>
                                <div class="admin-form-tags">
                                    <% models.filter(model => model.createEnabled).forEach(function(model) { %>
                                        <button class="admin-form-tag" style="background-color: <%= model.color || '#667eea' %>" 
                                                onclick="showCreateForm('<%= model.name %>', '<%= model.displayName %>')">
                                            <% if (model.icon) { %><%= model.icon %> <% } %><%= model.displayName %>ã‚’ä½œæˆ
                                        </button>
                                    <% }); %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å‹•çš„ãƒ¢ãƒ‡ãƒ«æ›´æ–°é–¢æ•°
        async function refreshModel(modelName, displayName) {
            try {
                const response = await fetch(`/admin/api/${modelName}?limit=20`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById(`${modelName}-content`);
                    container.innerHTML = renderModelData(modelName, result.data);
                }
            } catch (error) {
                console.error(`Error refreshing ${displayName}:`, error);
            }
        }

        // å‹•çš„ãƒ‡ãƒ¼ã‚¿æç”»é–¢æ•°
        function renderModelData(modelName, data) {
            if (modelName === 'messages') {
                return data.map(item => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-user">${item.username || 'ä¸æ˜'}</span>
                            <span class="message-time">
                                ${item.timestamp ? new Date(item.timestamp).toLocaleString('ja-JP') : 'æ™‚åˆ»ä¸æ˜'}
                            </span>
                        </div>
                        <div class="message-content">${item.message || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ãªã—'}</div>
                        <span class="message-room">ãƒ«ãƒ¼ãƒ : ${item.room || 'general'}</span>
                    </div>
                `).join('');
            } else if (modelName === 'rooms') {
                return data.map(item => `
                    <div class="room-item">
                        <div class="room-info">
                            <div class="room-name">
                                ${item.name || 'åå‰ãªã—'}
                                ${item.isDefault ? '<span class="badge default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>' : ''}
                                <span class="badge ${item.status === 'active' ? 'active' : 'archived'}">
                                    ${item.status === 'active' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}
                                </span>
                            </div>
                            <div class="room-desc">${item.description || 'èª¬æ˜ãªã—'}</div>
                        </div>
                        <div class="room-stats">
                            <div>ã‚¿ã‚¤ãƒ—: ${item.type || 'general'}</div>
                            <div>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${item.messageCount || 0}</div>
                            <div>ä½œæˆæ—¥: ${item.createdAt ? new Date(item.createdAt).toLocaleDateString('ja-JP') : 'ä¸æ˜'}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                // æ±ç”¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                return data.map(item => `
                    <div class="message-item">
                        <div class="message-header">
                            <span class="message-user">
                                ${item.username || item.name || item.title || 'ID: ' + (item._id ? item._id.toString().slice(-6) : 'ä¸æ˜')}
                            </span>
                            <span class="message-time">
                                ${item.createdAt ? new Date(item.createdAt).toLocaleString('ja-JP') : 
                                  item.timestamp ? new Date(item.timestamp).toLocaleString('ja-JP') : 'æ™‚åˆ»ä¸æ˜'}
                            </span>
                        </div>
                        <div class="message-content">
                            ${item.description || item.message || item.content || 'ãƒ‡ãƒ¼ã‚¿å†…å®¹ãªã—'}
                        </div>
                        ${item.status ? `<span class="message-room">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${item.status}</span>` : ''}
                    </div>
                `).join('');
            }
        }

        // å‹•çš„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆãƒ¢ãƒ‡ãƒ«åã¨ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤åã‚’å—ã‘å–ã‚‹ï¼‰
        function refreshãƒ¦ãƒ¼ã‚¶ãƒ¼(modelName) { refreshModel(modelName, 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'); }
        function refreshãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(modelName) { refreshModel(modelName, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'); }
        function refreshãƒ«ãƒ¼ãƒ (modelName) { refreshModel(modelName, 'ãƒ«ãƒ¼ãƒ '); }

        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
        function refreshMessages() { refreshModel('messages', 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'); }
        function refreshRooms() { refreshModel('rooms', 'ãƒ«ãƒ¼ãƒ '); }

        // ãƒ¢ãƒ‡ãƒ«åˆ¥è¨­å®šã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¯¾å¿œï¼‰
        const modelSettings = {};

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadModelSettings() {
            try {
                const saved = localStorage.getItem('adminPaginationSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(modelSettings, parsed);
                    console.log('Loaded pagination settings from localStorage:', modelSettings);
                }
            } catch (error) {
                console.warn('Failed to load pagination settings from localStorage:', error);
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®šã‚’ä¿å­˜
        function saveModelSettings() {
            try {
                localStorage.setItem('adminPaginationSettings', JSON.stringify(modelSettings));
                console.log('Saved pagination settings to localStorage:', modelSettings);
            } catch (error) {
                console.warn('Failed to save pagination settings to localStorage:', error);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šã‚’å¾©å…ƒ
        loadModelSettings();

        // å‹•çš„ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºé–¢æ•°ï¼ˆä¸€è¦§ã¨ãƒ•ã‚©ãƒ¼ãƒ åŒæ™‚è¡¨ç¤ºï¼‰
        async function loadModelData(modelName, displayName, page = 1, itemsPerPage = null) {
            // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’ç¢ºå®Ÿã«æ•°å€¤ã«å¤‰æ›
            const pageNumber = parseInt(page, 10) || 1;
            const finalItemsPerPageNumber = itemsPerPage ? parseInt(itemsPerPage, 10) : null;
            
            // æ—¢å­˜ã®è¨­å®šã‚’å–å¾—ã¾ãŸã¯åˆæœŸåŒ–
            if (!modelSettings[modelName]) {
                modelSettings[modelName] = { itemsPerPage: null };
            }
            
            // itemsPerPageãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ—¢å­˜ã®è¨­å®šã‚’ä½¿ç”¨
            const finalItemsPerPage = finalItemsPerPageNumber || modelSettings[modelName].itemsPerPage;
            
            console.log(`Loading ${displayName} - Page: ${pageNumber} (original: ${page}, type: ${typeof page}), ItemsPerPage: ${finalItemsPerPage}, Saved settings:`, modelSettings[modelName]);
            console.log(`API URL will be: /admin/api/${modelName}/paginated?page=${pageNumber}${finalItemsPerPage ? `&itemsPerPage=${finalItemsPerPage}` : ''}`);
            
            currentView = { type: 'model', modelName, displayName, page: pageNumber, itemsPerPage: finalItemsPerPage };
            console.log('currentView updated:', currentView);
            
            const container = document.getElementById('data-table-content');
            const formContainer = document.getElementById('create-form-content');
            
            // ä¸¡æ–¹ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            container.innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            formContainer.innerHTML = '<div class="loading">ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                // APIã®URLã‚’æ§‹ç¯‰ï¼ˆitemsPerPageãŒã‚ã‚‹å ´åˆã®ã¿ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ ï¼‰
                let apiUrl = `/admin/api/${modelName}/paginated?page=${pageNumber}`;
                if (finalItemsPerPage) {
                    apiUrl += `&itemsPerPage=${finalItemsPerPage}`;
                }
                console.log(`Final API URL: ${apiUrl}`);
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒ‡ãƒ¼ã‚¿ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã‚’ä¸¦åˆ—ã§å–å¾—
                const [dataResponse, fieldsResponse, configResponse] = await Promise.all([
                    fetch(apiUrl),
                    fetch(`/admin/api/${modelName}/fields`),
                    fetch(`/admin/api/${modelName}/pagination-config`)
                ]);
                
                if (!dataResponse.ok) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${dataResponse.status}`);
                }
                
                const [dataResult, fieldsResult, configResult] = await Promise.all([
                    dataResponse.json(),
                    fieldsResponse.ok ? fieldsResponse.json() : { success: false, error: 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ãªã—' },
                    configResponse.ok ? configResponse.json() : { success: false, error: 'è¨­å®šæƒ…å ±ãªã—' }
                ]);
                
                console.log(`${displayName} data loaded:`, dataResult);
                console.log(`${displayName} fields loaded:`, fieldsResult);
                console.log(`${displayName} config loaded:`, configResult);
                
                // å®Ÿéš›ã«ä½¿ç”¨ã•ã‚ŒãŸitemsPerPageã‚’ä¿å­˜
                if (dataResult.pagination && dataResult.pagination.itemsPerPage) {
                    modelSettings[modelName].itemsPerPage = dataResult.pagination.itemsPerPage;
                    currentView.itemsPerPage = dataResult.pagination.itemsPerPage;
                    saveModelSettings(); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                }
                
                // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã®ãƒ‡ãƒãƒƒã‚°
                if (dataResult.pagination) {
                    console.log(`${displayName} pagination:`, dataResult.pagination);
                    console.log('- totalItems:', dataResult.pagination.totalItems, typeof dataResult.pagination.totalItems);
                    console.log('- totalPages:', dataResult.pagination.totalPages, typeof dataResult.pagination.totalPages);
                    console.log('- currentPage:', dataResult.pagination.currentPage, typeof dataResult.pagination.currentPage);
                    console.log('- itemsPerPage:', dataResult.pagination.itemsPerPage, typeof dataResult.pagination.itemsPerPage);
                    
                    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å…¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª
                    console.log('All pagination properties:', Object.keys(dataResult.pagination));
                    console.log('Pagination object stringified:', JSON.stringify(dataResult.pagination, null, 2));
                }
                
                // ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
                if (dataResult.success && dataResult.data) {
                    container.innerHTML = generatePaginatedTableHTML(
                        modelName, 
                        displayName, 
                        dataResult.data, 
                        dataResult.pagination,
                        configResult.success ? configResult.data : null
                    );
                } else {
                    container.innerHTML = `<div class="error-message">${displayName}ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
                }
                
                // ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºï¼ˆä½œæˆå¯èƒ½ãªå ´åˆã®ã¿ï¼‰
                if (fieldsResult.success && fieldsResult.data && fieldsResult.data.length > 0) {
                    displayUnifiedCreateForm(modelName, displayName, fieldsResult.data);
                } else {
                    // ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®è¡¨ç¤º
                    formContainer.innerHTML = `
                        <div class="admin-form-welcome">
                            <div class="admin-form-welcome-icon">ğŸ“‹</div>
                            <h3>${displayName}ã‚’è¡¨ç¤ºä¸­</h3>
                            <p>å·¦å´ã«${displayName}ã®ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™</p>
                            <div class="admin-form-info-card">
                                <strong>ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯è¡¨ç¤ºå°‚ç”¨ã§ã™</strong><br>
                                æ–°è¦ä½œæˆæ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error(`Error loading ${displayName}:`, error);
                container.innerHTML = `<div class="error-message">${displayName}ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
                formContainer.innerHTML = `<div class="error-message">ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œãƒ†ãƒ¼ãƒ–ãƒ«HTMLç”Ÿæˆ
        function generatePaginatedTableHTML(modelName, displayName, data, pagination, config) {
            if (data.length === 0) {
                return `
                    <div class="paginated-table-container">
                        <div class="error-message">${displayName}ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
            }

            const showId = config?.showId !== false;

            // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
            const headerHTML = `
                <div class="paginated-header">
                    <h3>${displayName}ä¸€è¦§</h3>
                    <div class="paginated-info">
                        ${pagination ? `
                            <span class="total-items">ç·ä»¶æ•°: ${parseInt(pagination.totalItems) || 0}ä»¶</span>
                            <span class="current-page">ãƒšãƒ¼ã‚¸ ${parseInt(pagination.currentPage) || 1} / ${parseInt(pagination.totalPages) || 1}</span>
                        ` : ''}
                    </div>
                </div>
            `;

            let tableHTML = '';

            // ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
            if (modelName === 'auth') {
                tableHTML = `
                    <table class="data-table paginated-table">
                        <thead>
                            <tr>
                                ${showId ? '<th>ID</th>' : ''}
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>ç™»éŒ²æ—¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    ${showId ? `<td class="id-cell">${item._id}</td>` : ''}
                                    <td><strong>${item.username}</strong></td>
                                    <td>${formatDate(item.createdAt)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (modelName === 'messages') {
                tableHTML = `
                    <table class="data-table paginated-table">
                        <thead>
                            <tr>
                                ${showId ? '<th>ID</th>' : ''}
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                                <th>ãƒ«ãƒ¼ãƒ </th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>é€ä¿¡æ—¥æ™‚</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    ${showId ? `<td class="id-cell">${item._id}</td>` : ''}
                                    <td><strong>${item.username}</strong></td>
                                    <td class="message-cell">${item.message}</td>
                                    <td><span class="room-tag">${item.room}</span></td>
                                    <td><span class="message-type-${item.type}">${item.type}</span></td>
                                    <td>${formatDate(item.timestamp)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (modelName === 'rooms') {
                tableHTML = `
                    <table class="data-table paginated-table">
                        <thead>
                            <tr>
                                ${showId ? '<th>ID</th>' : ''}
                                <th>ãƒ«ãƒ¼ãƒ å</th>
                                <th>èª¬æ˜</th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</th>
                                <th>æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    ${showId ? `<td class="id-cell">${item._id}</td>` : ''}
                                    <td><strong>${item.name}</strong></td>
                                    <td class="description-cell">${item.description || '-'}</td>
                                    <td><span class="room-type-${item.type}">${item.type}</span></td>
                                    <td><span class="room-status-${item.status}">${item.status}</span></td>
                                    <td class="count-cell">${item.messageCount || 0}</td>
                                    <td>${formatDate(item.lastActivity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                // æ±ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
                const keys = Object.keys(data[0] || {}).filter(key => !['__v', 'password'].includes(key));
                if (showId && !keys.includes('_id')) {
                    keys.unshift('_id');
                }
                
                tableHTML = `
                    <table class="data-table paginated-table">
                        <thead>
                            <tr>
                                ${keys.map(key => `<th>${key === '_id' ? 'ID' : key}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    ${keys.map(key => {
                                        const value = item[key];
                                        const cellClass = key === '_id' ? 'id-cell' : '';
                                        return `<td class="${cellClass}">${formatCellValue(value, key)}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†
            const paginationHTML = pagination ? generatePaginationHTML(modelName, displayName, pagination) : '';
            
            console.log(`generatePaginatedTableHTML - Generated paginationHTML length: ${paginationHTML.length}`);
            if (paginationHTML.length > 0) {
                console.log(`generatePaginatedTableHTML - PaginationHTML preview:`, paginationHTML.substring(0, 200) + '...');
            }

            const finalHTML = `
                <div class="paginated-table-container">
                    ${headerHTML}
                    ${tableHTML}
                    ${paginationHTML}
                </div>
            `;
            
            console.log(`generatePaginatedTableHTML - Final HTML length: ${finalHTML.length}`);
            return finalHTML;
        }

        // å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«HTMLç”Ÿæˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        function generateTableHTML(modelName, displayName, data) {
            if (data.length === 0) {
                return `<div class="error-message">${displayName}ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
            }

            // ãƒ¢ãƒ‡ãƒ«å›ºæœ‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
            if (modelName === 'auth') {
                return `
                    <h3>${displayName}ä¸€è¦§ (${data.length}ä»¶)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>ä½œæˆæ—¥</th>
                                <th>æ›´æ–°æ—¥</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td>${item.username || 'ä¸æ˜'}</td>
                                    <td>${item.createdAt ? new Date(item.createdAt).toLocaleString('ja-JP') : 'ä¸æ˜'}</td>
                                    <td>${item.updatedAt ? new Date(item.updatedAt).toLocaleString('ja-JP') : 'ä¸æ˜'}</td>
                                    <td style="font-family: monospace; font-size: 0.8rem;">${item._id || 'ä¸æ˜'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (modelName === 'messages') {
                return `
                    <h3>${displayName}ä¸€è¦§ (${data.length}ä»¶)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                                <th>ãƒ«ãƒ¼ãƒ </th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>æ™‚åˆ»</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td>${item.username || 'ä¸æ˜'}</td>
                                    <td style="max-width: 300px; word-break: break-word;">${item.message || 'ãªã—'}</td>
                                    <td>${item.room || 'general'}</td>
                                    <td>${item.type || 'text'}</td>
                                    <td>${item.timestamp ? new Date(item.timestamp).toLocaleString('ja-JP') : 'ä¸æ˜'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (modelName === 'rooms') {
                return `
                    <h3>${displayName}è©³ç´° (${data.length}ä»¶)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>åå‰</th>
                                <th>èª¬æ˜</th>
                                <th>ã‚¿ã‚¤ãƒ—</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°</th>
                                <th>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</th>
                                <th>ä½œæˆæ—¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    <td>${item.name || 'åå‰ãªã—'}</td>
                                    <td style="max-width: 200px; word-break: break-word;">${item.description || 'ãªã—'}</td>
                                    <td>${item.type || 'general'}</td>
                                    <td>
                                        <span class="badge ${item.status === 'active' ? 'active' : 'archived'}">
                                            ${item.status === 'active' ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}
                                        </span>
                                    </td>
                                    <td>${item.messageCount || 0}</td>
                                    <td>${item.isDefault ? 'ã¯ã„' : 'ã„ã„ãˆ'}</td>
                                    <td>${item.createdAt ? new Date(item.createdAt).toLocaleString('ja-JP') : 'ä¸æ˜'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                // æ±ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
                const firstItem = data[0];
                const columns = Object.keys(firstItem).filter(key => 
                    !key.startsWith('__') && typeof firstItem[key] !== 'object' || key === '_id'
                );
                
                return `
                    <h3>${displayName}ä¸€è¦§ (${data.length}ä»¶)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(item => `
                                <tr>
                                    ${columns.map(col => `
                                        <td style="${col === '_id' ? 'font-family: monospace; font-size: 0.8rem;' : ''}">
                                            ${item[col] || 'ä¸æ˜'}
                                        </td>
                                    `).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        // å…¨çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        async function loadAllStatistics() {
            try {
                const response = await fetch('/admin/api/statistics');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById('data-table-content');
                    const stats = result.data;
                    
                    container.innerHTML = `
                        <h3>ğŸ“Š å…¨çµ±è¨ˆæƒ…å ±</h3>
                        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                            ${Object.entries(stats).map(([modelName, data]) => `
                                <div style="padding: 1rem; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                                    <h4 style="color: ${data.color || '#667eea'}; margin-bottom: 0.5rem;">${data.name}</h4>
                                    <div style="font-size: 1.5rem; font-weight: bold;">${data.total}</div>
                                    ${data.recentRegistrations !== undefined ? `<div>æ–°è¦ç™»éŒ²ï¼ˆ30æ—¥é–“ï¼‰: ${data.recentRegistrations}</div>` : ''}
                                    ${data.activeUsers !== undefined ? `<div>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${data.activeUsers}</div>` : ''}
                                    ${data.error ? `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 1rem; color: #666;">
                            æœ€çµ‚æ›´æ–°: ${new Date(result.timestamp).toLocaleString('ja-JP')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                document.getElementById('data-table-content').innerHTML = '<div class="error-message">çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ¢ãƒ‡ãƒ«æƒ…å ±è¡¨ç¤º
        async function loadModelInfo() {
            try {
                const response = await fetch('/admin/api/models');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById('data-table-content');
                    container.innerHTML = `
                        <h3>ğŸ” ç™»éŒ²ãƒ¢ãƒ‡ãƒ«æƒ…å ± (${result.data.length}ä»¶)</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ãƒ¢ãƒ‡ãƒ«å</th>
                                    <th>è¡¨ç¤ºå</th>
                                    <th>çµ±è¨ˆæ©Ÿèƒ½</th>
                                    <th>æ¤œç´¢æ©Ÿèƒ½</th>
                                    <th>ã‚«ãƒ©ãƒ¼</th>
                                    <th>ã‚¢ã‚¤ã‚³ãƒ³</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(model => `
                                    <tr>
                                        <td style="font-family: monospace;">${model.name}</td>
                                        <td>${model.displayName}</td>
                                        <td>
                                            <span class="badge ${model.hasStatistics ? 'active' : 'archived'}">
                                                ${model.hasStatistics ? 'ã‚ã‚Š' : 'ãªã—'}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge ${model.hasSearch ? 'active' : 'archived'}">
                                                ${model.hasSearch ? 'ã‚ã‚Š' : 'ãªã—'}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; align-items: center;">
                                                <div style="width: 20px; height: 20px; background-color: ${model.color || '#667eea'}; border-radius: 3px; margin-right: 0.5rem;"></div>
                                                ${model.color || '#667eea'}
                                            </div>
                                        </td>
                                        <td style="font-size: 1.2rem;">${model.icon || 'â€”'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error loading model info:', error);
                document.getElementById('data-table-content').innerHTML = '<div class="error-message">ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ¢ãƒ‡ãƒ«çµ±è¨ˆè¡¨ç¤º
        async function loadModelStats(modelName, displayName) {
            try {
                const response = await fetch(`/admin/api/${modelName}/stats`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const container = document.getElementById('data-table-content');
                    const stats = result.data;
                    
                    container.innerHTML = `
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <h3>ğŸ“Š ${displayName} çµ±è¨ˆæƒ…å ±</h3>
                        </div>
                        <div style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                            <div style="padding: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; text-align: center;">
                                <div style="font-size: 2.5rem; font-weight: bold; color: #007bff; margin-bottom: 0.5rem;">
                                    ${stats.total || 0}
                                </div>
                                <div style="color: #6c757d;">ç·${displayName}æ•°</div>
                            </div>
                            ${stats.totalUsers ? `
                                <div style="padding: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #28a745; margin-bottom: 0.5rem;">
                                        ${stats.recentRegistrations || 0}
                                    </div>
                                    <div style="color: #6c757d;">æ–°è¦ç™»éŒ²ï¼ˆ30æ—¥é–“ï¼‰</div>
                                </div>
                                <div style="padding: 1.5rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; color: #ffc107; margin-bottom: 0.5rem;">
                                        ${stats.activeUsers || 0}
                                    </div>
                                    <div style="color: #6c757d;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 2rem; text-align: center;">
                            <button class="admin-toolbar-btn" onclick="loadModelData('${modelName}', '${displayName}')">
                                ğŸ“‹ ${displayName}ä¸€è¦§ã‚’è¡¨ç¤º
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`Error loading ${displayName} stats:`, error);
                document.getElementById('data-table-content').innerHTML = `<div class="error-message">${displayName}çµ±è¨ˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
            }
        }

        // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        let currentView = { type: 'welcome' };
        
        function refreshCurrentView() {
            if (currentView.type === 'model') {
                loadModelData(currentView.modelName, currentView.displayName);
            } else if (currentView.type === 'stats') {
                loadModelStats(currentView.modelName, currentView.displayName);
            } else if (currentView.type === 'allStats') {
                loadAllStatistics();
            } else if (currentView.type === 'modelInfo') {
                loadModelInfo();
            } else {
                // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã«æˆ»ã‚‹
                location.reload();
            }
        }

        // ãƒ“ãƒ¥ãƒ¼è¿½è·¡ã‚’æ›´æ–°
        const originalLoadModelData = loadModelData;
        loadModelData = function(modelName, displayName) {
            currentView = { type: 'model', modelName, displayName };
            return originalLoadModelData(modelName, displayName);
        };

        const originalLoadModelStats = loadModelStats;
        loadModelStats = function(modelName, displayName) {
            currentView = { type: 'stats', modelName, displayName };
            return originalLoadModelStats(modelName, displayName);
        };

        const originalLoadAllStatistics = loadAllStatistics;
        loadAllStatistics = function() {
            currentView = { type: 'allStats' };
            return originalLoadAllStatistics();
        };

        const originalLoadModelInfo = loadModelInfo;
        loadModelInfo = function() {
            currentView = { type: 'modelInfo' };
            return originalLoadModelInfo();
        };

        // çµ±ä¸€ã•ã‚ŒãŸä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºé–¢æ•°
        function displayUnifiedCreateForm(modelName, displayName, fields) {
            const container = document.getElementById('create-form-content');
            container.innerHTML = generateUnifiedFormHTML(modelName, displayName, fields);
            setupFormValidation(modelName);
        }

        // å‹•çš„ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç”¨ã€äº’æ›æ€§ç¶­æŒï¼‰
        async function showCreateForm(modelName, displayName) {
            try {
                const response = await fetch(`/admin/api/${modelName}/fields`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayUnifiedCreateForm(modelName, displayName, result.data);
                } else {
                    console.error('Failed to load fields:', result);
                }
            } catch (error) {
                console.error('Error loading create form:', error);
                document.getElementById('create-form-content').innerHTML = 
                    '<div class="form-error">ãƒ•ã‚©ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ HTMLç”Ÿæˆé–¢æ•°
        function generateUnifiedFormHTML(modelName, displayName, fields) {
            return `
                <div class="unified-form">
                    <div class="unified-form-header">
                        <h3>âœ¨ æ–°è¦${displayName}ä½œæˆ</h3>
                        <div class="unified-form-badge">ä½œæˆãƒ•ã‚©ãƒ¼ãƒ </div>
                    </div>
                    
                    <form id="create-form-${modelName}" onsubmit="submitUnifiedForm(event, '${modelName}', '${displayName}')">
                        <div class="unified-form-fields">
                            ${fields.map(field => generateUnifiedFieldHTML(field)).join('')}
                        </div>
                        
                        <div class="unified-form-actions">
                            <button type="submit" class="unified-form-submit" id="submit-btn-${modelName}">
                                <span class="button-icon">â•</span>
                                ${displayName}ã‚’ä½œæˆ
                            </button>
                            <button type="button" class="unified-form-reset" onclick="resetUnifiedForm('${modelName}')">
                                <span class="button-icon">ğŸ”„</span>
                                ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®æ—§é–¢æ•°
        function generateFormHTML(modelName, displayName, fields) {
            return generateUnifiedFormHTML(modelName, displayName, fields);
        }

        // çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰HTMLç”Ÿæˆé–¢æ•°
        function generateUnifiedFieldHTML(field) {
            const isRequired = field.required ? 'required' : '';
            const requiredClass = field.required ? 'required' : '';
            
            let inputHTML = '';
            
            switch (field.type) {
                case 'password':
                    inputHTML = `<input type="password" class="unified-form-input" name="${field.name}" 
                                        placeholder="${field.placeholder || ''}" ${isRequired}
                                        ${field.minLength ? `minlength="${field.minLength}"` : ''}
                                        ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}>`;
                    break;
                case 'number':
                    inputHTML = `<input type="number" class="unified-form-input" name="${field.name}" 
                                        placeholder="${field.placeholder || ''}" ${isRequired}
                                        ${field.min !== undefined ? `min="${field.min}"` : ''}
                                        ${field.max !== undefined ? `max="${field.max}"` : ''}
                                        value="${field.default || ''}">`;
                    break;
                case 'boolean':
                    inputHTML = `<label class="unified-checkbox-label">
                                    <input type="checkbox" class="unified-form-checkbox" name="${field.name}" 
                                           ${field.default ? 'checked' : ''}>
                                    <span class="unified-checkbox-text">${field.label}ã‚’æœ‰åŠ¹ã«ã™ã‚‹</span>
                                </label>`;
                    break;
                case 'date':
                    inputHTML = `<input type="datetime-local" class="unified-form-input" name="${field.name}" ${isRequired}>`;
                    break;
                case 'enum':
                    inputHTML = `<select class="unified-form-select" name="${field.name}" ${isRequired}>
                                    ${!field.required ? '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' : ''}
                                    ${field.enum.map(option => 
                                        `<option value="${option}" ${field.default === option ? 'selected' : ''}>${option}</option>`
                                    ).join('')}
                                </select>`;
                    break;
                default: // string
                    inputHTML = `<input type="text" class="unified-form-input" name="${field.name}" 
                                        placeholder="${field.placeholder || ''}" ${isRequired}
                                        ${field.minLength ? `minlength="${field.minLength}"` : ''}
                                        ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                                        value="${field.default || ''}">`;
            }
            
            if (field.type === 'boolean') {
                return `
                    <div class="unified-form-group unified-form-group-checkbox">
                        ${inputHTML}
                        ${field.description ? `<div class="unified-form-description">${field.description}</div>` : ''}
                    </div>
                `;
            }
            
            return `
                <div class="unified-form-group">
                    <label class="unified-form-label ${requiredClass}">${field.label || field.name}</label>
                    ${inputHTML}
                    ${field.description ? `<div class="unified-form-description">${field.description}</div>` : ''}
                </div>
            `;
        }

        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®æ—§é–¢æ•°
        function generateFieldHTML(field) {
            return generateUnifiedFieldHTML(field);
        }

        // çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–¢æ•°
        async function submitUnifiedForm(event, modelName, displayName) {
            event.preventDefault();
            
            const form = event.target;
            const submitBtn = document.getElementById(`submit-btn-${modelName}`);
            const formData = new FormData(form);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (form.elements[key].type === 'checkbox') {
                    data[key] = form.elements[key].checked;
                } else if (form.elements[key].type === 'number') {
                    data[key] = value ? Number(value) : undefined;
                } else {
                    data[key] = value || undefined;
                }
            }

            // ç©ºã®å€¤ã‚’é™¤å»
            Object.keys(data).forEach(key => {
                if (data[key] === undefined || data[key] === '') {
                    delete data[key];
                }
            });

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´
            const originalHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="button-icon">â³</span>ä½œæˆä¸­...';

            try {
                const response = await fetch(`/admin/api/${modelName}/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    showUnifiedSuccessMessage(displayName, result.data._id);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    form.reset();
                    
                    // å·¦å´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆé–¢æ•°ã‚’å‘¼ã³ç›´ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
                    refreshDataOnly(modelName, displayName);
                    
                } else {
                    throw new Error(result.error || 'Creation failed');
                }
            } catch (error) {
                console.error('Error creating data:', error);
                showUnifiedErrorMessage(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHTML;
            }
        }

        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®æ—§é–¢æ•°
        async function submitCreateForm(event, modelName, displayName) {
            return submitUnifiedForm(event, modelName, displayName);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
        function setupFormValidation(modelName) {
            const form = document.getElementById(`create-form-${modelName}`);
            if (!form) return;

            const inputs = form.querySelectorAll('.unified-form-input, .unified-form-select, .form-input, .form-select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });
                
                input.addEventListener('input', function() {
                    clearFieldError(this);
                });
            });
        }

        // å€‹åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateField(field) {
            const value = field.value;
            const required = field.hasAttribute('required');
            
            if (required && !value) {
                showFieldError(field, 'ã“ã®é …ç›®ã¯å¿…é ˆã§ã™');
                return false;
            }
            
            if (field.type === 'email' && value && !isValidEmail(value)) {
                showFieldError(field, 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }
            
            clearFieldError(field);
            return true;
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showFieldError(field, message) {
            clearFieldError(field);
            field.classList.add('error');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'form-error';
            errorDiv.textContent = message;
            field.parentNode.appendChild(errorDiv);
        }

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚¯ãƒªã‚¢
        function clearFieldError(field) {
            field.classList.remove('error');
            const errorDiv = field.parentNode.querySelector('.form-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        // çµ±ä¸€ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showUnifiedSuccessMessage(displayName, id) {
            const container = document.getElementById('create-form-content');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'unified-success-message';
            messageDiv.innerHTML = `
                <div class="unified-message-icon">âœ…</div>
                <div class="unified-message-text">
                    <strong>${displayName}ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼</strong>
                    <small>ID: ${id}</small>
                </div>
            `;
            
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }

        function showUnifiedErrorMessage(errorMessage) {
            const container = document.getElementById('create-form-content');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'unified-error-message';
            messageDiv.innerHTML = `
                <div class="unified-message-icon">âŒ</div>
                <div class="unified-message-text">
                    <strong>ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ</strong>
                    <small>${errorMessage}</small>
                </div>
            `;
            
            container.insertBefore(messageDiv, container.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
        async function refreshDataOnly(modelName, displayName) {
            const currentPage = parseInt(currentView?.page, 10) || 1;
            const currentItemsPerPage = modelSettings[modelName]?.itemsPerPage || currentView?.itemsPerPage || null;
            
            console.log(`refreshDataOnly called - currentView:`, currentView);
            console.log(`refreshDataOnly using currentPage: ${currentPage} (type: ${typeof currentPage}), itemsPerPage: ${currentItemsPerPage}`);
            
            try {
                // APIã®URLã‚’æ§‹ç¯‰ï¼ˆitemsPerPageãŒã‚ã‚‹å ´åˆã®ã¿ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ ï¼‰
                let apiUrl = `/admin/api/${modelName}/paginated?page=${currentPage}`;
                if (currentItemsPerPage) {
                    apiUrl += `&itemsPerPage=${currentItemsPerPage}`;
                }
                
                const [dataResponse, configResponse] = await Promise.all([
                    fetch(apiUrl),
                    fetch(`/admin/api/${modelName}/pagination-config`)
                ]);

                if (dataResponse.ok) {
                    const [dataResult, configResult] = await Promise.all([
                        dataResponse.json(),
                        configResponse.ok ? configResponse.json() : { success: false }
                    ]);

                    if (dataResult.success && dataResult.data) {
                        const container = document.getElementById('data-table-content');
                        container.innerHTML = generatePaginatedTableHTML(
                            modelName, 
                            displayName, 
                            dataResult.data, 
                            dataResult.pagination,
                            configResult.success ? configResult.data : null
                        );
                    }
                }
            } catch (error) {
                console.error(`Error refreshing ${displayName} data:`, error);
            }
        }

        // çµ±ä¸€ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆé–¢æ•°
        function resetUnifiedForm(modelName) {
            const form = document.getElementById(`create-form-${modelName}`);
            if (form) {
                form.reset();
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                form.querySelectorAll('.unified-form-input, .unified-form-select').forEach(input => {
                    clearFieldError(input);
                });
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é¸æŠç”»é¢ã«æˆ»ã‚‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        function resetCreateForm() {
            const container = document.getElementById('create-form-content');
            const welcomeContent = `
                <div class="admin-form-welcome">
                    <div class="admin-form-welcome-icon">âœ¨</div>
                    <h3>æ–°è¦ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h3>
                    <p>å·¦å´ã®ãƒ¢ãƒ‡ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€<br>ä½œæˆãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `;
            container.innerHTML = welcomeContent;
        }

        // é«˜æ©Ÿèƒ½ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³HTMLç”Ÿæˆ
        function generatePaginationHTML(modelName, displayName, pagination) {
            console.log('generatePaginationHTML called with:', { modelName, displayName, pagination });
            console.log('Pagination object type:', typeof pagination);
            console.log('Pagination object keys:', Object.keys(pagination || {}));
            console.log('Pagination object stringified:', JSON.stringify(pagination, null, 2));
            
            if (!pagination) {
                console.warn('No pagination data provided');
                return '';
            }
            
            // æ•°å€¤å‹ã«å¤‰æ›ã—ã¦å®‰å…¨æ€§ã‚’ç¢ºä¿
            const currentPage = parseInt(pagination.currentPage) || 1;
            const totalPages = parseInt(pagination.totalPages) || 1;
            const totalItems = parseInt(pagination.totalItems) || 0;
            const itemsPerPage = parseInt(pagination.itemsPerPage) || 10;
            
            console.log(`Pagination values - currentPage: ${currentPage} (original: ${pagination.currentPage}), totalPages: ${totalPages}, totalItems: ${totalItems}, itemsPerPage: ${itemsPerPage}`);
            console.log(`Raw pagination values - currentPage: ${pagination.currentPage}, totalPages: ${pagination.totalPages}, totalItems: ${pagination.totalItems}, itemsPerPage: ${pagination.itemsPerPage}`);
            
            if (totalPages <= 1 && totalItems <= itemsPerPage) {
                return `
                    <div class="pagination-container">
                        <div class="pagination-info">
                            <span>ç· ${totalItems} ä»¶ã‚’è¡¨ç¤º</span>
                        </div>
                        <div class="pagination-controls">
                            <div class="pagination-settings">
                                ${generateItemsPerPageSelector(modelName, displayName, itemsPerPage)}
                            </div>
                        </div>
                    </div>
                `;
            }

            const hasNext = pagination.hasNext || currentPage < totalPages;
            const hasPrev = pagination.hasPrev || currentPage > 1;
            
            // ãƒšãƒ¼ã‚¸ç•ªå·ã®ç¯„å›²ã‚’è¨ˆç®—ï¼ˆã‚ˆã‚Šè©³ç´°ãªè¡¨ç¤ºï¼‰
            let startPage = Math.max(1, currentPage - 3);
            let endPage = Math.min(totalPages, currentPage + 3);
            
            // æœ€ä½7ãƒšãƒ¼ã‚¸ã¯è¡¨ç¤ºï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            if (endPage - startPage < 6) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 6);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, endPage - 6);
                }
            }

            const pageNumbers = [];
            for (let i = startPage; i <= endPage; i++) {
                pageNumbers.push(i);
            }

            return `
                <div class="pagination-container" id="pagination-${modelName}">
                    <div class="pagination-info">
                        <span>ç· ${totalItems} ä»¶ä¸­ ${((currentPage - 1) * itemsPerPage) + 1} - ${Math.min(currentPage * itemsPerPage, totalItems)} ä»¶ã‚’è¡¨ç¤º</span>
                    </div>
                    
                    <div class="pagination-main-controls">
                        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="pagination-nav-controls">
                            <button class="pagination-btn nav-btn ${!hasPrev ? 'disabled' : ''}" 
                                    onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', 1)" 
                                    ${!hasPrev ? 'disabled' : ''}
                                    title="æœ€åˆã®ãƒšãƒ¼ã‚¸ã¸">
                                âª
                            </button>
                            <button class="pagination-btn nav-btn ${!hasPrev ? 'disabled' : ''}" 
                                    onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', ${currentPage - 1})" 
                                    ${!hasPrev ? 'disabled' : ''}
                                    title="å‰ã®ãƒšãƒ¼ã‚¸ã¸">
                                â—€
                            </button>
                        </div>
                        
                        <!-- ãƒšãƒ¼ã‚¸ç•ªå·è¡¨ç¤º -->
                        <div class="pagination-pages">
                            ${startPage > 1 ? `
                                <button class="pagination-btn page-btn" onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', 1)">1</button>
                                ${startPage > 2 ? '<span class="pagination-ellipsis" onclick="event.stopPropagation(); showPageJump(\'${modelName}\', \'${displayName}\', 1, ${startPage - 1})">...</span>' : ''}
                            ` : ''}
                            
                            ${pageNumbers.map(page => `
                                <button class="pagination-btn page-btn ${page === currentPage ? 'active' : ''}" 
                                        onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', ${page})"
                                        title="ãƒšãƒ¼ã‚¸ ${page}">
                                    ${page}
                                </button>
                            `).join('')}
                            
                            ${endPage < totalPages ? `
                                ${endPage < totalPages - 1 ? '<span class="pagination-ellipsis" onclick="event.stopPropagation(); showPageJump(\'${modelName}\', \'${displayName}\', ${endPage + 1}, ${totalPages})">...</span>' : ''}
                                <button class="pagination-btn page-btn" onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', ${totalPages})">${totalPages}</button>
                            ` : ''}
                        </div>
                        
                        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                        <div class="pagination-nav-controls">
                            <button class="pagination-btn nav-btn ${!hasNext ? 'disabled' : ''}" 
                                    onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', ${currentPage + 1})" 
                                    ${!hasNext ? 'disabled' : ''}
                                    title="æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸">
                                â–¶
                            </button>
                            <button class="pagination-btn nav-btn ${!hasNext ? 'disabled' : ''}" 
                                    onclick="event.stopPropagation(); navigateToPage('${modelName}', '${displayName}', ${totalPages})" 
                                    ${!hasNext ? 'disabled' : ''}
                                    title="æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¸">
                                â©
                            </button>
                        </div>
                    </div>
                    
                    <!-- é«˜åº¦ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                    <div class="pagination-advanced-controls">
                        <!-- ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ— -->
                        <div class="pagination-jump">
                            <input type="number" 
                                   class="pagination-jump-input" 
                                   id="page-jump-${modelName}"
                                   min="1" 
                                   max="${totalPages}" 
                                   value="${currentPage}"
                                   onkeypress="event.stopPropagation(); handlePageJumpKeypress(event, '${modelName}', '${displayName}')"
                                   title="ãƒšãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼">
                            <button class="pagination-jump-btn" 
                                    onclick="event.stopPropagation(); jumpToPage('${modelName}', '${displayName}')"
                                    title="æŒ‡å®šãƒšãƒ¼ã‚¸ã¸ç§»å‹•">
                                ç§»å‹•
                            </button>
                        </div>
                        
                        <!-- ä»¶æ•°é¸æŠ -->
                        <div class="pagination-settings">
                            ${generateItemsPerPageSelector(modelName, displayName, itemsPerPage)}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatDate(dateValue) {
            if (!dateValue) return '-';
            try {
                return new Date(dateValue).toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateValue.toString();
            }
        }

        // ã‚»ãƒ«å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatCellValue(value, key) {
            if (value === null || value === undefined) return '-';
            
            if (key === '_id') {
                return value.toString().slice(-8); // IDã®æœ€å¾Œ8æ–‡å­—ã‚’è¡¨ç¤º
            }
            
            if (key.includes('Date') || key.includes('At') || key === 'timestamp' || key === 'lastActivity') {
                return formatDate(value);
            }
            
            if (typeof value === 'boolean') {
                return value ? 'âœ…' : 'âŒ';
            }
            
            if (typeof value === 'object') {
                return JSON.stringify(value);
            }
            
            const str = value.toString();
            if (str.length > 50) {
                return str.substring(0, 47) + '...';
            }
            
            return str;
        }

        // ãƒšãƒ¼ã‚¸ä»¶æ•°é¸æŠHTMLç”Ÿæˆ
        function generateItemsPerPageSelector(modelName, displayName, currentItemsPerPage) {
            const options = [5, 10, 15, 20, 25, 50, 100];
            return `
                <label class="pagination-items-label">
                    è¡¨ç¤ºä»¶æ•°:
                    <select class="pagination-items-select" 
                            onchange="event.stopPropagation(); changeItemsPerPage('${modelName}', '${displayName}', this.value)">
                        ${options.map(option => `
                            <option value="${option}" ${option === currentItemsPerPage ? 'selected' : ''}>
                                ${option}ä»¶
                            </option>
                        `).join('')}
                    </select>
                </label>
            `;
        }

        // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ï¼ˆè¨­å®šã‚’ç¶­æŒï¼‰
        function navigateToPage(modelName, displayName, page) {
            let pageNumber = parseInt(page, 10);
            console.log(`navigateToPage called with: modelName=${modelName}, displayName=${displayName}, page=${page} (type: ${typeof page}) -> parsed: ${pageNumber}`);
            
            if (isNaN(pageNumber) || pageNumber < 1) {
                console.error('Invalid page number:', page, '-> using page 1');
                pageNumber = 1;
            }
            
            // ç¾åœ¨ã®è¡¨ç¤ºä»¶æ•°è¨­å®šã‚’ç¶­æŒ
            const currentItemsPerPage = modelSettings[modelName]?.itemsPerPage || null;
            console.log(`Using itemsPerPage: ${currentItemsPerPage} for navigation`);
            loadModelData(modelName, displayName, pageNumber, currentItemsPerPage);
        }

        // ä»¶æ•°å¤‰æ›´æ™‚ã®å‡¦ç†
        function changeItemsPerPage(modelName, displayName, newItemsPerPage) {
            console.log(`Changing items per page to ${newItemsPerPage} for ${modelName}`);
            // è¨­å®šã‚’ä¿å­˜
            if (!modelSettings[modelName]) {
                modelSettings[modelName] = {};
            }
            modelSettings[modelName].itemsPerPage = parseInt(newItemsPerPage);
            saveModelSettings(); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            
            // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’1ã«æˆ»ã—ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰
            loadModelData(modelName, displayName, 1, parseInt(newItemsPerPage));
        }

        // ä»¶æ•°æŒ‡å®šã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰ï¼ˆçµ±åˆç‰ˆä½¿ç”¨ï¼‰
        async function loadModelDataWithItemsPerPage(modelName, displayName, page = 1, itemsPerPage) {
            // çµ±åˆã•ã‚ŒãŸé–¢æ•°ã‚’ä½¿ç”¨
            return loadModelData(modelName, displayName, page, itemsPerPage);
        }

        // ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½
        function jumpToPage(modelName, displayName) {
            const input = document.getElementById(`page-jump-${modelName}`);
            const page = parseInt(input.value);
            
            if (page && page > 0) {
                navigateToPage(modelName, displayName, page);
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—ã®ã‚­ãƒ¼ãƒ—ãƒ¬ã‚¹å‡¦ç†
        function handlePageJumpKeypress(event, modelName, displayName) {
            if (event.key === 'Enter') {
                event.preventDefault();
                jumpToPage(modelName, displayName);
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚¸ãƒ£ãƒ³ãƒ—ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        function showPageJump(modelName, displayName, minPage, maxPage) {
            const page = prompt(`ãƒšãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ${minPage}-${maxPage}ï¼‰:`, minPage);
            if (page !== null) {
                const pageNum = parseInt(page);
                if (pageNum >= minPage && pageNum <= maxPage) {
                    navigateToPage(modelName, displayName, pageNum);
                } else {
                    alert(`ãƒšãƒ¼ã‚¸ç•ªå·ã¯${minPage}ã‹ã‚‰${maxPage}ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                }
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        document.addEventListener('keydown', function(event) {
            // Ctrl + çŸ¢å°ã‚­ãƒ¼ã§ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            if (event.ctrlKey && currentView && currentView.type === 'model') {
                const { modelName, displayName, page } = currentView;
                
                switch(event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        if (page > 1) {
                            navigateToPage(modelName, displayName, page - 1);
                        }
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        // æ¬¡ãƒšãƒ¼ã‚¸ã¸ï¼ˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ã¯é–¢æ•°å†…ã§è¡Œã†ï¼‰
                        navigateToPage(modelName, displayName, page + 1);
                        break;
                    case 'Home':
                        event.preventDefault();
                        navigateToPage(modelName, displayName, 1);
                        break;
                    case 'End':
                        event.preventDefault();
                        // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¸ï¼ˆãƒšãƒ¼ã‚¸æƒ…å ±ãŒå¿…è¦ï¼‰
                        const paginationContainer = document.getElementById(`pagination-${modelName}`);
                        if (paginationContainer) {
                            const lastPageBtn = paginationContainer.querySelector('.pagination-btn.page-btn:last-of-type');
                            if (lastPageBtn) {
                                const lastPage = parseInt(lastPageBtn.textContent);
                                navigateToPage(modelName, displayName, lastPage);
                            }
                        }
                        break;
                }
            }
        });

        // Email validation helper
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã®æ—§é–¢æ•°
        function loadUsers() { loadModelData('auth', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'); }
        function loadAllMessages() { loadModelData('messages', 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'); }
        function loadAllRooms() { loadModelData('rooms', 'ãƒ«ãƒ¼ãƒ '); }
    </script>
</body>
</html>
